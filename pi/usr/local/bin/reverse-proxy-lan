#!/bin/bash

hostnames="$1"
if [ -z "$hostnames" ]; then
  echo "No target hostnames given (comma-delimited)."
  exit 1
fi

ips=()
for hostname in $(echo ${hostnames//:/ }); do
  # can't memo-ize arp output, entire string turns into a single line
  ip="$(arp -a | grep "$hostname" | awk '{print $2}' | sed 's/^(\(.*\))$/\1/')"
  
  if [ -z "$ip" ]; then
    echo "WARNING: could not find IP for $hostname, skipping..."
    continue
  else
    echo "Found IP $ip for host $hostname"
  fi

  ips[${#ips[@]}]="$ip"
done

echo "Reverse-Searched IPs:"
echo "${ips[*]}"

# ansible here for writing to /etc/nginx/nginx.conf based on ./etc/nginx/nginx.conf.j2

docker rm -f nginx-reverse-proxy || echo "No container named 'nginx-reverse-proxy to remove.'"
docker run --rm \
  --name nginx-reverse-proxy \
  --log-driver json-file --log-opt max-size=8m --log-opt max-file=3 \
  -v /etc/nginx/nginx.conf:/etc/nginx/nginx.conf \
  --net=host nginx:1.21.1-alpine
